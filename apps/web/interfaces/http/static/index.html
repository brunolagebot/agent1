<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent1 v0.5.1</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: system-ui; 
      background: #0f1419;
      color: #e3e8ec;
      padding: 20px;
    }
    .header { text-align: center; padding: 20px; background: #1a2332; border-radius: 8px; margin-bottom: 20px; }
    .container { max-width: 1200px; margin: 0 auto; display: flex; gap: 20px; }
    .sidebar { width: 260px; background: #1a2332; padding: 20px; border-radius: 8px; }
    .main { flex: 1; background: #1a2332; padding: 20px; border-radius: 8px; }
    button { padding: 10px 20px; background: #2d6a7a; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #3d8a9a; }
    input, textarea { width: 100%; padding: 10px; background: #0f1419; color: white; border: 1px solid #2d6a7a; border-radius: 6px; }
    #messages { height: 400px; overflow-y: auto; margin: 20px 0; padding: 10px; background: #0f1419; border-radius: 6px; }
    #telemetry { 
      background: rgba(26, 35, 50, 0.8); 
      border: 1px solid #2d6a7a; 
      border-radius: 6px; 
      padding: 12px; 
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      display: none;
    }
    #telemetry.active { display: block; }
    .telem-stage { 
      padding: 4px 0; 
      display: flex; 
      justify-content: space-between;
      color: #7a9ca8;
    }
    .telem-stage.done { color: #5db88f; }
    .telem-stage.current { color: #3d8a9a; font-weight: bold; }
    .telem-time { color: #a8c5d1; }
    .msg { padding: 10px; margin: 5px 0; border-radius: 6px; }
    .user { background: #2d6a7a; text-align: right; }
    .assistant { background: #1a4d5e; }
    .conv-item { padding: 10px; margin: 5px 0; background: #0f1419; border-radius: 6px; cursor: pointer; }
    .conv-item:hover { background: #2d6a7a; }
  </style>
</head>
<body>
  <div class="header">
    <h1>ü§ñ Agent1 v0.5.1</h1>
    <p>Modo Treinamento ‚Ä¢ Qwen2.5:14b</p>
  </div>

  <div class="container">
    <div class="sidebar">
      <button onclick="newChat()" style="width: 100%; margin-bottom: 20px;">‚ûï Nova Conversa</button>
      <h3 style="margin-bottom: 10px;">Hist√≥rico</h3>
      <div id="convList"></div>
    </div>

    <div class="main">
      <h3>üí¨ Chat - Modo Treinamento</h3>
      <div id="telemetry">
        <div style="color: #a8c5d1; font-weight: bold; margin-bottom: 8px;">‚è±Ô∏è Telemetria em Tempo Real</div>
        <div id="telemStages"></div>
      </div>
      <div id="messages"></div>
      <div id="status" style="margin: 10px 0; color: #7a9ca8; font-size: 13px;"></div>
      <textarea id="input" placeholder="Digite sua mensagem..." rows="3"></textarea>
      <button onclick="send()" style="margin-top: 10px; width: 100%;">Enviar</button>
    </div>
  </div>

  <script>
    let convId = null;
    let convs = [];
    
    const stageLabels = {
      'create_conversation': '1. Criar/carregar conversa',
      'save_user_message': '2. Salvar mensagem usu√°rio',
      'load_history': '3. Carregar hist√≥rico',
      'search_documents': '4. Buscar em documentos',
      'search_knowledge_base': '5. Consultar Knowledge Base',
      'prepare_context': '6. Preparar contexto',
      'llm_generation': '7. Gerar resposta (LLM)',
      'save_assistant_message': '8. Salvar resposta',
    };

    function showTelemetry() {
      const box = document.getElementById('telemetry');
      const stages = document.getElementById('telemStages');
      box.classList.add('active');
      
      stages.innerHTML = Object.entries(stageLabels).map(([key, label]) =>
        '<div class="telem-stage" id="stage-' + key + '">' +
          '<span>' + label + '</span>' +
          '<span class="telem-time">‚è≥</span>' +
        '</div>'
      ).join('');
    }

    function hideTelemetry() {
      document.getElementById('telemetry').classList.remove('active');
    }

    function updateStage(stage, status, duration) {
      const el = document.getElementById('stage-' + stage);
      if (!el) return;
      
      if (status === 'current') {
        el.className = 'telem-stage current';
        el.querySelector('.telem-time').textContent = '‚è≥ processando...';
      } else if (status === 'done') {
        el.className = 'telem-stage done';
        el.querySelector('.telem-time').textContent = '‚úì ' + duration + 'ms';
      }
    }

    async function loadConvs() {
      try {
        const r = await fetch('/api/conversations');
        const d = await r.json();
        convs = d.conversations || [];
        renderConvs();
      } catch (e) {
        console.error(e);
      }
    }

    function renderConvs() {
      const list = document.getElementById('convList');
      if (convs.length === 0) {
        list.innerHTML = '<p style="color: #7a9ca8;">Nenhuma conversa</p>';
        return;
      }
      
      list.innerHTML = '';
      convs.slice(0, 20).forEach(c => {
        const div = document.createElement('div');
        div.className = 'conv-item';
        div.textContent = (c.title || 'Conversa').substring(0, 30);
        div.onclick = () => loadConv(c.id);
        list.appendChild(div);
      });
    }

    async function loadConv(id) {
      try {
        convId = id;
        const r = await fetch('/api/conversations/' + id + '/messages');
        const d = await r.json();
        
        document.getElementById('messages').innerHTML = '';
        d.messages.forEach(m => addMsg(m.role, m.content));
      } catch (e) {
        console.error(e);
      }
    }

    function newChat() {
      convId = null;
      document.getElementById('messages').innerHTML = '';
      document.getElementById('input').value = '';
    }

    function addMsg(role, text) {
      const div = document.createElement('div');
      div.className = 'msg ' + role;
      div.textContent = text;
      document.getElementById('messages').appendChild(div);
      document.getElementById('messages').scrollTop = 999999;
    }

    async function send() {
      const input = document.getElementById('input');
      const msg = input.value.trim();
      if (!msg) return;

      addMsg('user', msg);
      input.value = '';
      
      // Mostrar telemetria
      showTelemetry();
      document.getElementById('status').textContent = 'üöÄ Iniciando processamento...';

      // Simular progresso das etapas (estimativa visual)
      const stages = Object.keys(stageLabels);
      let currentIdx = 0;
      
      const progressInterval = setInterval(() => {
        if (currentIdx < stages.length) {
          updateStage(stages[currentIdx], 'current', 0);
          if (currentIdx > 0) {
            updateStage(stages[currentIdx - 1], 'done', '~');
          }
          
          // Atualizar status
          document.getElementById('status').textContent = stageLabels[stages[currentIdx]];
          currentIdx++;
        }
      }, 3000); // A cada 3s muda de etapa (estimativa)

      try {
        const start = Date.now();
        
        const r = await fetch('/api/chat', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({conversationId: convId, message: msg})
        });

        clearInterval(progressInterval);
        const totalTime = Date.now() - start;

        const d = await r.json();
        if (d.error) throw new Error(d.error);

        convId = d.conversationId;
        addMsg('assistant', d.assistantMessage);
        
        // Atualizar telemetria com dados reais
        if (d.telemetry && d.telemetry.stages) {
          Object.entries(d.telemetry.stages).forEach(([stageName, data]) => {
            updateStage(stageName, 'done', data.duration);
          });
        } else {
          // Marcar todas como conclu√≠das
          stages.forEach(s => updateStage(s, 'done', '?'));
        }
        
        document.getElementById('status').textContent = '‚úÖ Pronto! (' + (totalTime / 1000).toFixed(1) + 's total)';
        loadConvs();
        
        setTimeout(() => {
          document.getElementById('status').textContent = '';
          hideTelemetry();
        }, 5000);
      } catch (e) {
        clearInterval(progressInterval);
        hideTelemetry();
        document.getElementById('status').textContent = '‚ùå Erro: ' + e.message;
        console.error(e);
      }
    }

    // Enter para enviar
    document.getElementById('input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    // Carregar ao iniciar
    loadConvs();
  </script>
</body>
</html>

